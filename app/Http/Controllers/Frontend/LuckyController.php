<?php namespace App\Http\Controllers\Frontend;use App\Models\LuckyHistory;use App\Models\Product;use App\Models\Tbl_Cash_Inven;use App\User;use Carbon\Carbon;use Illuminate\Http\Request;use App\Http\Controllers\Controller;use Illuminate\Support\Facades\DB;use Auth;class LuckyController extends Controller{public function index(){$listProduct=Product::where('prd_status',1)->where('luckyStatus',2)->get();$data=[];foreach($listProduct as $value){$data[]=['text'=>$value->prd_name,'img'=>'/uploads/imgProduct/'.$value->prd_thunbar,'percentpage'=>(int) $value->ratioLucky/100,'id'=>(int) $value->id,'prd_code'=>$value->prd_code];}$showHistory=LuckyHistory::with('user')->with('product')->orderBy('id','desc')->limit(10)->get();$luckyNumber=User::where('id',Auth::guard('web')->user()->id)->value('luckyNumber');return view('frontend.lucky',compact('data','luckyNumber','showHistory'));}public function luckyProduct(Request $request){$rand=(float) rand()/(float) getrandmax();$result=-1;foreach($request->prizes as $key=>$value){if($rand<$value['percentpage']){$result=$key;break;}$rand-=$value['percentpage'];}$kq=$request->prizes[$result];$check=User::where('id',Auth::guard('web')->user()->id)->value('luckyNumber');if($check<=0){return response()->json(['message'=>'err']);}else{LuckyHistory::insert(['productId'=>$kq['id'],'userId'=>Auth::guard('web')->user()->id,'created_at'=>Carbon::now(),'updated_at'=>Carbon::now()]);User::where('id',Auth::guard('web')->user()->id)->decrement('luckyNumber');Tbl_Cash_Inven::insert(['item_code'=>$kq['prd_code'],'item_user_id'=>Auth::guard('web')->user()->userid,'item_server_code'=>0,'item_present'=>0,'order_input_date'=>Carbon::now()]);$luckyNumber=User::where('id',Auth::guard('web')->user()->id)->value('luckyNumber');$data=['luckyNumber'=>$luckyNumber,'result'=>$result];return response()->json($data);}}public function getHistoryRolanty(){$showHistory=LuckyHistory::with('user')->with('product')->orderBy('id','desc')->limit(10)->get();$data=['showHistory'=>$showHistory];return response()->json($data);}}